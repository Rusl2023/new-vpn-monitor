name: Filter VLESS Servers

on:
  schedule:
    - cron: '0 * * * *'   # каждый час (можно поменять по необходимости)
  workflow_dispatch:

jobs:
  filter-vless:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filter VLESS servers from 26.txt
        run: |
          python - <<'EOF'
          import requests
          import os

          URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"
          OUTPUT_FILE = "githubmirror/26_alive_filtered.txt"

          os.makedirs("githubmirror", exist_ok=True)

          print("Downloading 26.txt ...")
          r = requests.get(URL, timeout=20)
          r.raise_for_status()
          lines = r.text.splitlines()

          # Фильтруем только VLESS-ссылки
          vless_links = [l.strip() for l in lines if l.strip().startswith("vless://")]

          print(f"Found {len(vless_links)} VLESS links")

          with open(OUTPUT_FILE, "w") as f:
              for link in vless_links:
                  f.write(link + "\n")

          print(f"Saved to {OUTPUT_FILE}")
          EOF

      - name: Commit filtered servers
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add githubmirror/26_alive_filtered.txt
          git diff --cached --quiet || git commit -m "Update 26_alive_filtered.txt"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} HEAD:main
