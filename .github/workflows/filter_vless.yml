name: Filter VLESS Servers

on:
  schedule:
    - cron: '0 * * * *'  # каждый час
  workflow_dispatch:

jobs:
  filter-vless:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Шаг 1: Checkout без встроенного токена
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # ⚠️ отключаем токен по умолчанию

      # -----------------------------
      # Шаг 2: Фильтруем VLESS
      # -----------------------------
      - name: Filter VLESS servers from 26.txt
        run: |
          python - <<'END_PYTHON'
import requests
import os

URL = "https://github.com/AvenCores/goida-vpn-configs/raw/refs/heads/main/githubmirror/26.txt"
OUTPUT_FILE = "githubmirror/26_alive_filtered.txt"

os.makedirs("githubmirror", exist_ok=True)

print("Downloading 26.txt ...")
r = requests.get(URL, timeout=20)
r.raise_for_status()
lines = r.text.splitlines()

vless_links = [l.strip() for l in lines if l.strip().startswith("vless://")]

print(f"Found {len(vless_links)} VLESS links")

with open(OUTPUT_FILE, "w") as f:
    for link in vless_links:
        f.write(link + "\n")

print(f"Saved to {OUTPUT_FILE}")
END_PYTHON

      # -----------------------------
      # Шаг 3: Commit и push через GH_PAT
      # -----------------------------
      - name: Commit filtered servers
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add githubmirror/26_alive_filtered.txt

          if git diff --cached --quiet; then
              echo "No changes to commit"
          else
              git commit -m "Update 26_alive_filtered.txt"
              git push https://x-access-token:${GH_PAT}@github.com/Rusl2023/new-vpn-monitor.git HEAD:main
